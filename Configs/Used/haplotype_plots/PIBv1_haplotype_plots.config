//General parameters for nextflow execution:
process.executor = "slurm"
process.clusterOptions = '--requeue'
//SLURM general submission options:
executor {
   queueSize = 300
   submitRateLimit = '100/5min'
}

//Input parameters for the pipeline:
//Directory for final outputs:
params.run_name = "PIBv1"
params.output_prefix = "/gpfs/gibbs/pi/tucci/pfr8/Friedlaender/AnalysisFreezes"
params.output_dir = "${params.output_prefix}/${params.run_name}_haplotype_plots"

//Modern sample VCFs (phased):
params.modern_glob = "${params.output_dir}/modern_VCFs/*.vcf.gz"
params.modern_regex = ~/_chr(\p{Alnum}+)_phased$/
//Archaic VCFs (phased):
params.archaic_glob = "${params.output_dir}/archaic_VCFs/*.vcf.gz"
params.archaic_regex = ~/_chr(\p{Alnum}+)_pop_phased$/

//Minimum global MAF for filtering variants:
params.minmaf = "0.01"

//Samples to keep for plotting:
params.samples_to_keep = "${params.output_dir}/${params.run_name}_samples_to_plot.txt"

//Regions to plot, in UCSC-like coordinates (i.e. [chromosome]:[1-based start]-[1-based end]):
//This file should consist of seven columns separated by tabs:
// 1) Chromosome of the region
// 2) Short name (alphanumeric, no special characters) of the region (used for filenames)
// 3) Region coordinates in UCSC-like format
// 4) Sprime tract ID
// 5) Sprime core haplotype ID
// 6) Pilot Sprime tract ID
// 7) Path to file of paths to rsids of published variants (can be empty file, files of rsids should be named *_[locus short name].txt)
params.target_regions = "${params.output_dir}/${params.run_name}_target_regions.tsv"

//Files for the site-presence matrix:
//MPRA emVar BEDs:
params.k562_bed = "/gpfs/gibbs/pi/tucci/pfr8/Friedlaender/MPRA/PIB92_pilot/results/K562/adaptive_variants_MPRA_K562_variant_ucsc_custom_track.bed"
params.jurkat_bed = "/gpfs/gibbs/pi/tucci/pfr8/Friedlaender/MPRA/PIB92_pilot/results/Jurkat/adaptive_variants_MPRA_Jurkat_variant_ucsc_custom_track.bed"
//Final Sprime score files:
//Pipeline is coded to take first capture group as pop and second as chrom
params.final_sprime_glob = "/gpfs/gibbs/pi/tucci/pfr8/Friedlaender/AnalysisFreezes/PIBv1_Sprime/Sprime/*_Sprime.score"
params.final_sprime_regex = ~/^([0-9A-Za-z,-]+)_chr(\p{Alnum}+)_Sprime$/
//Core haplotype matches files:
//Pipeline is coded to take first capture group as pop
params.corehap_glob = "/gpfs/gibbs/pi/tucci/pfr8/Friedlaender/AnalysisFreezes/PIBv1_Sprime/corehaps/*_corehaps_matches.tsv"
params.corehap_regex = ~/^([0-9A-Za-z,-]+)_Sprime_corehaps_matches$/
//Pilot Sprime score files:
//Pipeline is coded to take first capture group as chrom and second as pop
params.pilot_glob = "/gpfs/gibbs/pi/tucci/pfr8/Friedlaender/FullDepthBatches/First92_analysis/hs37d5/joint_genotyping_with_SerenaData/Sprime/pop_results/PIB92_SD_hs37d5_SNP_VQSR99.5_INDEL_VQSR99.0_dbSNP138_VQSRpass_chr*_Sprime_defaults.score"
params.pilot_regex = ~/_chr(\p{Alnum}+)_([0-9A-Za-z,-]+)_Sprime_defaults$/

//Sample-Region map including archaics:
params.samplemap = "${params.output_dir}/${params.run_name}_sample_region_map.tsv"
//Column names for sample map:
//Sample ID column name:
params.samplecol = "SampleID"
//Region column name:
params.regioncol = "Region"

//Debugging options:
trace {
   enabled = true
   fields = 'task_id,name,hash,status,exit,cpus,memory,time,submit,start,complete,duration,%cpu,%mem,peak_rss,workdir'
   file = "${params.output_dir}/${params.run_name}_haplotype_plots_nextflow_trace.txt"
   raw = true
   overwrite = true
}

//Reference-related parameters for the pipeline:
profiles {
   hs37d5 {
      //Reference-related parameters for the pipeline:
      params.ref_prefix = "/gpfs/gibbs/pi/tucci/pfr8/refs"
      params.ref = "${params.ref_prefix}/1kGP/hs37d5/hs37d5.fa"
      //Ancestral allele FASTAs:
      params.aa_glob = "/gpfs/gibbs/pi/tucci/pfr8/human_ancestor/Ensembl_R75_GRCh37/homo_sapiens_ancestor_GRCh37_e71/homo_sapiens_ancestor_*.fa"
      params.aa_regex = ~/ancestor_(\p{Alnum}+)$/
      //TSVs from WGSA of CADD 1.6 scores:
      params.cadd_glob = "/gpfs/gibbs/pi/tucci/pfr8/WGSA/resources/CADDv1.6/hg19/whole_genome_SNVs.tsv.gz.chr*.gz.rankRawScore.gz"
      params.cadd_regex = ~/[.]chr(\p{Alnum}+)[.]gz[.]rankRawScore[.]gz$/
      //GFF3 annotation of the reference:
      params.ref_annotation = "/gpfs/gibbs/pi/tucci/pfr8/refs/GENCODE/r38/gencode.v38lift37.annotation.gff3.gz"
      //dbSNP VCF:
      params.dbsnp_vcf = "/gpfs/gibbs/pi/tucci/pfr8/Archaic/ACVD_merged_dbSNP154/final_VCFs/dbSNP_154_hs37d5.vcf.gz"
      //VEP details:
      params.vep_cache = "/gpfs/gibbs/pi/tucci/pfr8/vep_r107_cache/"
      params.vep_species = "homo_sapiens"
      params.vep_assembly = "GRCh37"
   }

   mccleary {
      params.mod_bcftools = "bcftools/f2d2fdf"
      params.mod_htslib = "htslib/c1634e7"
      params.mod_samtools = "samtools/c80ab28"
      params.mod_bedtools = "bedtools/b891a0b"
      params.mod_vep = "VEP/107-GCC-10.2.0"
      process.queue = "day,week"
   }

   ruddle {
      params.mod_bcftools = "bcftools/1eba45c"
      params.mod_htslib = "htslib/a1dec95"
      params.mod_samtools = ""
      params.mod_bedtools = "bedtools/cc714eb"
      params.mod_vep = ""
   }
}

//SLURM submission parameters:
//*_ramp is the constant added each retry
//*_unit is the unit for that resource
//So *_mem = 1 with *_mem_ramp = 8 and *_mem_unit = 'GB' would
// initially allocate 1 GB memory, then 9 GB on first retry,
// 17 GB on second retry, etc. until maxRetries is satisfied
//Modern samples
params.modern_cpus = 1
params.modern_mem = 1
params.modern_mem_ramp = 8
params.modern_mem_unit = 'GB'
params.modern_timeout = 1
params.modern_timeout_ramp = 4
params.modern_timeout_unit = 'h'
//Archaic hominins
params.archaic_cpus = 1
params.archaic_mem = 1
params.archaic_mem_ramp = 8
params.archaic_mem_unit = 'GB'
params.archaic_timeout = 1
params.archaic_timeout_ramp = 4
params.archaic_timeout_unit = 'h'
//Merge
params.merge_cpus = 1
params.merge_mem = 1
params.merge_mem_ramp = 8
params.merge_mem_unit = 'GB'
params.merge_timeout = 1
params.merge_timeout_ramp = 4
params.merge_timeout_unit = 'h'
//Add ancestral alleles
params.addanc_cpus = 1
params.addanc_mem = 1
params.addanc_mem_ramp = 8
params.addanc_mem_unit = 'GB'
params.addanc_timeout = 1
params.addanc_timeout_ramp = 4
params.addanc_timeout_unit = 'h'
//Output haplotypes
params.hapsout_cpus = 1
params.hapsout_mem = 1
params.hapsout_mem_ramp = 8
params.hapsout_mem_unit = 'GB'
params.hapsout_timeout = 1
params.hapsout_timeout_ramp = 4
params.hapsout_timeout_unit = 'h'
//Extract CADD scores
params.cadd_cpus = 1
params.cadd_mem = 1
params.cadd_mem_ramp = 8
params.cadd_mem_unit = 'GB'
params.cadd_timeout = 1
params.cadd_timeout_ramp = 4
params.cadd_timeout_unit = 'h'
//Overlapping PCGs
//Base memory usage is high, since Nextflow fails to catch the OOM
params.pcgs_cpus = 1
params.pcgs_mem = 4
params.pcgs_mem_ramp = 8
params.pcgs_mem_unit = 'GB'
params.pcgs_timeout = 1
params.pcgs_timeout_ramp = 4
params.pcgs_timeout_unit = 'h'
//VEP
params.vep_cpus = 1
params.vep_mem = 4
params.vep_mem_ramp = 8
params.vep_mem_unit = 'GB'
params.vep_timeout = 1
params.vep_timeout_ramp = 4
params.vep_timeout_unit = 'h'
//Site-presence matrix
params.matrix_cpus = 1
params.matrix_mem = 1
params.matrix_mem_ramp = 8
params.matrix_mem_unit = 'GB'
params.matrix_timeout = 1
params.matrix_timeout_ramp = 4
params.matrix_timeout_unit = 'h'
